-- 1. USERS Table: Central Authentication for all roles (Admin, Doctor, Patient)
CREATE TABLE Users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL, -- Store hashed password (e.g., using PHP's password_hash())
    role ENUM('Admin', 'Doctor', 'Patient') NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. DOCTORS Table: Doctor-specific information (UPDATED)
CREATE TABLE Doctors (
    doctor_id INT PRIMARY KEY, -- Links to Users.user_id
    full_name VARCHAR(150),    -- Added for easier retrieval on landing page
    specialization VARCHAR(100) NOT NULL,
    contact_info VARCHAR(255),
    image_url VARCHAR(255) DEFAULT 'assets/img/default_doctor.jpg', -- NEW FIELD for landing page display
    availability JSON, -- Stores doctor's schedule/slots
    FOREIGN KEY (doctor_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

-- 3. PATIENTS Table: Patient-specific demographics and insurance
CREATE TABLE Patients (
    patient_id INT PRIMARY KEY, -- Links to Users.user_id
    full_name VARCHAR(150) NOT NULL,
    age INT,
    gender ENUM('Male', 'Female', 'Other'),
    contact_phone VARCHAR(20),
    insurance_policy_number VARCHAR(100), -- For Billing & Insurance Automation
    FOREIGN KEY (patient_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

-- 4. ADMINS Table: (Optional, only needed if Admin has unique data points)
CREATE TABLE Admins (
    admin_id INT PRIMARY KEY, -- Links to Users.user_id
    FOREIGN KEY (admin_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

-- 5. APPOINTMENTS Table: Tracks all bookings
CREATE TABLE Appointments (
    appointment_id INT AUTO_INCREMENT PRIMARY KEY,
    patient_id INT NOT NULL,
    doctor_id INT NOT NULL,
    appointment_datetime DATETIME NOT NULL,
    reason VARCHAR(255),
    status ENUM('Scheduled', 'Completed', 'Cancelled', 'Rescheduled') DEFAULT 'Scheduled',
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES Doctors(doctor_id),
    UNIQUE KEY unique_appointment (doctor_id, appointment_datetime) -- Prevents double booking
);

-- 6. MEDICAL RECORDS Table: The master record for a patient's visit
CREATE TABLE MedicalRecords (
    record_id INT AUTO_INCREMENT PRIMARY KEY,
    patient_id INT NOT NULL,
    doctor_id INT NOT NULL,
    appointment_id INT UNIQUE, -- Links to the appointment that created this record
    visit_date DATE NOT NULL,
    diagnosis TEXT, -- Updated by Doctor
    ai_prediction_score DECIMAL(5,2), -- AI-Powered Disease Prediction
    ai_prediction_details TEXT, -- Suggested condition from AI
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES Doctors(doctor_id),
    FOREIGN KEY (appointment_id) REFERENCES Appointments(appointment_id)
);

-- 7. PRESCRIPTIONS Table: Digital prescriptions
CREATE TABLE Prescriptions (
    prescription_id INT AUTO_INCREMENT PRIMARY KEY,
    record_id INT NOT NULL, -- Links to the specific visit/record
    medicine_name VARCHAR(150) NOT NULL,
    dosage VARCHAR(50),
    instructions TEXT,
    FOREIGN KEY (record_id) REFERENCES MedicalRecords(record_id) ON DELETE CASCADE
);

-- 8. INVESTIGATIONS Table: Lab tests, X-rays, etc.
CREATE TABLE Investigations (
    investigation_id INT AUTO_INCREMENT PRIMARY KEY,
    record_id INT NOT NULL, -- Links to the specific visit/record
    test_name VARCHAR(150) NOT NULL,
    report_file_path VARCHAR(255), -- Path to the uploaded PDF/image (for doctors to upload)
    result_summary TEXT, -- Summary of the result
    report_date DATE,
    FOREIGN KEY (record_id) REFERENCES MedicalRecords(record_id) ON DELETE CASCADE
);

-- 9. BILLING Table: For invoicing and payment tracking
CREATE TABLE Billing (
    bill_id INT AUTO_INCREMENT PRIMARY KEY,
    patient_id INT NOT NULL,
    appointment_id INT UNIQUE, -- Bill generated after an appointment
    bill_date DATE NOT NULL,
    service_description VARCHAR(255),
    amount DECIMAL(10, 2) NOT NULL,
    insurance_claim_status ENUM('Pending', 'Approved', 'Rejected') DEFAULT 'Pending',
    payment_status ENUM('Pending', 'Paid', 'Partial') DEFAULT 'Pending',
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id),
    FOREIGN KEY (appointment_id) REFERENCES Appointments(appointment_id)
);

-- 10. REMINDERS Table: For preventive care and follow-ups (AI-Driven)
CREATE TABLE Reminders (
    reminder_id INT AUTO_INCREMENT PRIMARY KEY,
    patient_id INT NOT NULL,
    reminder_type ENUM('Appointment', 'Preventive Checkup', 'Medication Refill') NOT NULL,
    reminder_date DATE NOT NULL,
    message TEXT NOT NULL,
    status ENUM('Active', 'Sent', 'Dismissed') DEFAULT 'Active',
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id)
);

-- ALTER 1: Add new demographic fields to the PATIENTS table
ALTER TABLE Patients
ADD COLUMN date_of_birth DATE AFTER full_name,
ADD COLUMN email VARCHAR(100) NULL AFTER contact_phone,
ADD COLUMN emergency_contact_name VARCHAR(150),
ADD COLUMN emergency_contact_number VARCHAR(20),
ADD COLUMN emergency_contact_relation VARCHAR(50);

-- ALTER 2: Drop the existing 'age' column as it will be calculated by PHP
-- (It's better to store DOB and calculate age dynamically)
ALTER TABLE Patients
DROP COLUMN age;

-- ALTER 3: Drop the redundant 'gender' ENUM column (if not using it in another table)
-- If you need gender data, you can keep it. Assuming you do:
-- (No change needed for gender if you keep it)

-- ALTER 1: Update the DOCTORS table structure

ALTER TABLE Doctors
    -- 1. Rename specialization to expertise (as requested)
    CHANGE COLUMN specialization expertise VARCHAR(100) NOT NULL,
    -- 2. Rename contact_info to contact_number (to be used as login ID)
    CHANGE COLUMN contact_info contact_number VARCHAR(20) NOT NULL,
    -- 3. Add Qualification field
    ADD COLUMN qualification VARCHAR(255) AFTER expertise,
    -- 4. Add Gender field
    ADD COLUMN gender ENUM('Male', 'Female', 'Other') AFTER qualification;

-- NOTE: The 'full_name' field should already exist in the Doctors table from the previous steps.

ALTER TABLE Appointments 
ADD COLUMN appointment_date DATE NOT NULL AFTER patient_id;

ALTER TABLE Patients 
ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE Users ADD COLUMN password VARCHAR(255) NOT NULL AFTER username;

ALTER TABLE Appointments ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;
-- Main Billing Table
-- 1. Remove the old table first
DROP TABLE IF EXISTS Billing;

-- 2. Now create the fresh version
CREATE TABLE Billing (
    bill_id INT PRIMARY KEY AUTO_INCREMENT,
    patient_id INT NOT NULL,
    appointment_id INT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    tax_amount DECIMAL(10, 2) DEFAULT 0.00,
    total_payable DECIMAL(10, 2) NOT NULL,
    billing_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    due_date DATE,
    status ENUM('Pending', 'Paid', 'Partially Paid', 'Cancelled') DEFAULT 'Pending',
    payment_method ENUM('Cash', 'Card', 'Online', 'Insurance') DEFAULT 'Cash',
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id)
);

-- Insurance Claims Module
CREATE TABLE InsuranceClaims (
    claim_id INT PRIMARY KEY AUTO_INCREMENT,
    bill_id INT NOT NULL,
    patient_id INT NOT NULL,
    provider_name VARCHAR(100),
    policy_number VARCHAR(50),
    claim_amount DECIMAL(10, 2),
    claim_status ENUM('Submitted', 'Under Review', 'Approved', 'Rejected') DEFAULT 'Submitted',
    document_path VARCHAR(255), -- Link to uploaded claim form
    submission_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (bill_id) REFERENCES Billing(bill_id),
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id)
);

-- 1. Create the Consultations Table
CREATE TABLE IF NOT EXISTS Consultations (
    consultation_id INT AUTO_INCREMENT PRIMARY KEY,
    appointment_id INT NOT NULL,
    patient_id INT NOT NULL,
    doctor_id INT NOT NULL,
    symptoms TEXT,
    diagnosis TEXT,
    advice TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    -- This line ensures only 1 report per appointment (Your Requirement)
    UNIQUE (appointment_id),
    -- Foreign Key Links
    FOREIGN KEY (appointment_id) REFERENCES Appointments(appointment_id) ON DELETE CASCADE,
    FOREIGN KEY (patient_id) REFERENCES Patients(patient_id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- 2. Create the Prescriptions Table
CREATE TABLE IF NOT EXISTS Prescriptions (
    prescription_id INT AUTO_INCREMENT PRIMARY KEY,
    consultation_id INT NOT NULL,
    medicine_name VARCHAR(255) NOT NULL,
    dosage VARCHAR(100),
    duration VARCHAR(100),
    FOREIGN KEY (consultation_id) REFERENCES Consultations(consultation_id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- Check if prescriptions table exists and add the column
ALTER TABLE Prescriptions 
ADD COLUMN consultation_id INT(11) NOT NULL AFTER prescription_id;

-- Add the relationship (Optional but recommended)
ALTER TABLE Prescriptions
ADD CONSTRAINT fk_consultation
FOREIGN KEY (consultation_id) REFERENCES Consultations(consultation_id)
ON DELETE CASCADE;

-- 1. Fix the Consultations table if needed
-- (Ensuring it has consultation_id as the primary key)
CREATE TABLE IF NOT EXISTS Consultations (
    consultation_id INT AUTO_INCREMENT PRIMARY KEY,
    appointment_id INT NOT NULL,
    patient_id INT NOT NULL,
    doctor_id INT NOT NULL,
    symptoms TEXT,
    diagnosis TEXT,
    advice TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. Fix the Prescriptions table
-- (Adding the missing consultation_id, dosage, and duration columns)
CREATE TABLE IF NOT EXISTS Prescriptions (
    prescription_id INT AUTO_INCREMENT PRIMARY KEY,
    consultation_id INT NOT NULL,
    medicine_name VARCHAR(255) NOT NULL,
    dosage VARCHAR(100),
    duration VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (consultation_id) REFERENCES Consultations(consultation_id) ON DELETE CASCADE
);


-- 1. Remove the old column if it still exists in Prescriptions
ALTER TABLE Prescriptions DROP FOREIGN KEY IF EXISTS prescriptions_ibfk_1;
ALTER TABLE Prescriptions DROP COLUMN IF EXISTS record_id;

-- 2. Ensure Billing table is ready for the automated entry
-- We add 'total_amount' if it's missing (to match your Billing table schema)
ALTER TABLE Billing MODIFY COLUMN status ENUM('Pending', 'Paid', 'Partially Paid', 'Cancelled', 'Unpaid') DEFAULT 'Unpaid';